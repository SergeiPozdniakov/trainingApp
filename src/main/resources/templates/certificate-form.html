<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${certificate.id != null} ? 'Редактирование экзамена' : 'Новый экзамен'">
    Новый экзамен
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .file-upload {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .file-upload:hover {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    .file-upload.dragover {
        border-color: #198754;
        background-color: rgba(25, 135, 84, 0.1);
    }
    .applicable-badge {
        font-size: 0.9rem;
        padding: 5px 10px;
    }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a th:href="@{/dashboard}">Главная</a></li>
      <li class="breadcrumb-item"><a th:href="@{/departments}">Подразделения</a></li>
      <li class="breadcrumb-item">
        <a th:href="@{/departments/{id}(id=${certificate.employee.department.id})}"
           th:text="${certificate.employee.department.name}"></a>
      </li>
      <li class="breadcrumb-item active" th:text="${certificate.id != null} ? 'Редактирование экзамена' : 'Новый экзамен'"></li>
    </ol>
  </nav>

  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow">
        <div class="card-header" th:classappend="${certificate.id != null} ? 'bg-warning' : 'bg-primary'">
          <h4 class="card-title text-white mb-0">
            <i th:classappend="${certificate.id != null} ? 'fas fa-edit' : 'fas fa-file-certificate'"
               class="me-2"></i>
            <span th:text="${certificate.id != null} ? 'Редактирование экзамена' : 'Новый экзамен'"></span>
          </h4>
        </div>

        <div class="card-body p-4">
          <!-- Информация о сотруднике и направлении -->
          <div class="alert alert-info mb-4">
            <div class="row">
              <div class="col-md-6">
                <strong><i class="fas fa-user me-1"></i> Сотрудник:</strong>
                <span th:text="${certificate.employee.fullName}"></span>
                <br>
                <small class="text-muted" th:text="${certificate.employee.position}"></small>
              </div>
              <div class="col-md-6">
                <strong><i class="fas fa-certificate me-1"></i> Направление:</strong>
                <span th:text="${certificate.trainingType.name}"></span>
                <br>
                <small class="text-muted">
                  Периодичность:
                  <span th:text="${certificate.trainingType.validityPeriodMonths}"></span> мес.
                </small>
              </div>
            </div>
          </div>

          <form th:action="@{${certificate.id != null} ? '/certificates/' + ${certificate.id} : '/certificates'}"
                method="post" th:object="${certificate}" enctype="multipart/form-data">

            <div th:if="${certificate.id != null}">
              <input type="hidden" name="_method" value="put" />
            </div>

            <input type="hidden" th:field="*{employee.id}" />
            <input type="hidden" th:field="*{trainingType.id}" />

            <div class="row">
              <!-- Дата экзамена -->
              <div class="col-md-6 mb-3">
                <label for="examDate" class="form-label fw-bold">
                  <i class="fas fa-calendar-day me-1"></i>Дата экзамена
                </label>
                <input type="date" class="form-control" id="examDate"
                       th:field="*{examDate}" required>
                <div th:if="${#fields.hasErrors('examDate')}" class="invalid-feedback d-block">
                  <span th:errors="*{examDate}"></span>
                </div>
              </div>

              <!-- Номер протокола -->
              <div class="col-md-6 mb-3">
                <label for="protocolNumber" class="form-label fw-bold">
                  <i class="fas fa-hashtag me-1"></i>Номер протокола
                </label>
                <input type="text" class="form-control" id="protocolNumber"
                       th:field="*{protocolNumber}" required
                       placeholder="Например: ПБ-2023-001">
                <div th:if="${#fields.hasErrors('protocolNumber')}" class="invalid-feedback d-block">
                  <span th:errors="*{protocolNumber}"></span>
                </div>
              </div>
            </div>

            <!-- Применимость -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                <i class="fas fa-check-circle me-1"></i>Применимость сертификата
              </label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="applicable"
                       id="applicableTrue" th:field="*{applicable}" value="true"
                       th:checked="${certificate.applicable == true}">
                <label class="btn btn-outline-success applicable-badge" for="applicableTrue">
                  <i class="fas fa-check me-1"></i> Применимо
                  <div class="small text-muted">Ячейка будет окрашена</div>
                </label>

                <input type="radio" class="btn-check" name="applicable"
                       id="applicableFalse" th:field="*{applicable}" value="false"
                       th:checked="${certificate.applicable == false}">
                <label class="btn btn-outline-secondary applicable-badge" for="applicableFalse">
                  <i class="fas fa-times me-1"></i> Неприменимо
                  <div class="small text-muted">Ячейка будет серой</div>
                </label>
              </div>
            </div>

            <!-- Загрузка файла -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                <i class="fas fa-file-pdf me-1"></i>Протокол экзамена (PDF)
              </label>

              <!-- Загруженный файл -->
              <div th:if="${certificate.filePath != null}" class="mb-3">
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <span>Протокол загружен</span>
                    <br>
                    <small class="text-muted">
                      <a th:href="@{/certificates/{id}/download(id=${certificate.id})}"
                         class="text-decoration-none">
                        Скачать файл
                      </a>
                    </small>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="document.getElementById('file').value = ''; this.parentNode.style.display = 'none';">
                    Удалить
                  </button>
                </div>
              </div>

              <!-- Поле загрузки -->
              <div class="file-upload" id="fileUpload">
                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-3"></i>
                <p class="mb-2">Перетащите PDF файл сюда или нажмите для выбора</p>
                <p class="small text-muted mb-3">
                  Максимальный размер: без ограничений<br>
                  Поддерживается только формат PDF
                </p>
                <input type="file" class="form-control d-none" id="file"
                       name="file" accept=".pdf">
                <button type="button" class="btn btn-outline-primary"
                        onclick="document.getElementById('file').click()">
                  <i class="fas fa-folder-open me-1"></i> Выбрать файл
                </button>
              </div>

              <!-- Предпросмотр файла -->
              <div id="filePreview" class="mt-3" style="display: none;">
                <div class="alert alert-light d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    <span id="fileName"></span>
                    <br>
                    <small class="text-muted" id="fileSize"></small>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger"
                          onclick="clearFile()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Расчет следующей даты -->
            <div th:if="${certificate.id != null && certificate.nextExamDueDate != null}"
                 class="alert alert-secondary">
              <div class="row">
                <div class="col-md-6">
                  <strong>Следующая проверка:</strong>
                  <br>
                  <span class="h5" th:text="${#dates.format(certificate.nextExamDueDate, 'dd.MM.yyyy')}"></span>
                </div>
                <div class="col-md-6">
                  <div th:if="${certificate.applicable}">
                                            <span th:switch="${certificate.statusColor}">
                                                <span th:case="'green'" class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i> Действителен
                                                </span>
                                                <span th:case="'red'" class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i> Истекает (менее 3 месяцев)
                                                </span>
                                                <span th:case="'orange'" class="badge bg-warning">
                                                    <i class="fas fa-exclamation-circle me-1"></i> Просрочен
                                                </span>
                                            </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Кнопки действия -->
            <div class="d-flex justify-content-between mt-4">
              <a th:href="@{/departments/{id}(id=${certificate.employee.department.id})}"
                 class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i> Отмена
              </a>
              <button type="submit" class="btn"
                      th:classappend="${certificate.id != null} ? 'btn-warning' : 'btn-primary'">
                <i th:classappend="${certificate.id != null} ? 'fas fa-save' : 'fas fa-check'"
                   class="me-1"></i>
                <span th:text="${certificate.id != null} ? 'Сохранить изменения' : 'Создать запись'"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('file');
      const fileUpload = document.getElementById('fileUpload');
      const filePreview = document.getElementById('filePreview');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');

      // Drag and drop
      fileUpload.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.classList.add('dragover');
      });

      fileUpload.addEventListener('dragleave', function(e) {
          e.preventDefault();
          this.classList.remove('dragover');
      });

      fileUpload.addEventListener('drop', function(e) {
          e.preventDefault();
          this.classList.remove('dragover');
          if (e.dataTransfer.files.length) {
              fileInput.files = e.dataTransfer.files;
              showFilePreview(e.dataTransfer.files[0]);
          }
      });

      // Клик по области загрузки
      fileUpload.addEventListener('click', function(e) {
          if (e.target !== fileInput) {
              fileInput.click();
          }
      });

      // Выбор файла через диалог
      fileInput.addEventListener('change', function(e) {
          if (this.files.length) {
              showFilePreview(this.files[0]);
          }
      });

      // Установить сегодняшнюю дату по умолчанию
      const examDateInput = document.getElementById('examDate');
      if (!examDateInput.value) {
          const today = new Date().toISOString().split('T')[0];
          examDateInput.value = today;
          examDateInput.max = today; // Нельзя выбрать будущую дату
      }
  });

  function showFilePreview(file) {
      if (file.type !== 'application/pdf') {
          alert('Пожалуйста, выберите PDF файл');
          return;
      }

      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('filePreview').style.display = 'block';
  }

  function clearFile() {
      document.getElementById('file').value = '';
      document.getElementById('filePreview').style.display = 'none';
  }

  function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
</script>
</body>
</html>